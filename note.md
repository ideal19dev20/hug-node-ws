### 功能说明 (Function)

1.  **多协议代理服务**:
    *   服务器的核心功能是作为一个代理中继 (Proxy Relay)。它支持 **VLESS** 和 **Trojan** 两种主流的代理协议。
    *   用户可以通过兼容的客户端（如 v2rayN, Clash, Shadowrocket 等）连接到这个服务器，服务器会将用户的网络请求转发到其真实的目标地址，从而实现代理上网。

2.  **动态订阅链接生成**:
    *   服务器提供一个订阅地址 (URL路径为 `/${SUB_PATH}`，默认是 `/sub`)。
    *   当用户访问这个地址时，服务器会根据环境变量中的配置（如 `UUID`, `DOMAIN` 等）动态生成 VLESS 和 Trojan 协议的配置链接。
    *   这些链接被编码成 Base64 格式，可以直接导入到客户端中，方便用户配置。

3.  **哪吒监控 Agent (Nezha Monitoring)**:
    *   服务器集成了 "哪吒监控" 的客户端 Agent。
    *   启动时，它会根据环境变量 (`NEZHA_SERVER`, `NEZHA_KEY` 等) 的配置，自动下载对应系统架构 (amd64/arm64) 的 Agent 程序。
    *   然后，它会在后台运行这个 Agent，将服务器的实时状态（如 CPU、内存、网络流量等）上报到用户指定的哪吒监控面板上。

4.  **自动保活 (Keep-Alive)**:
    *   项目包含一个可选的自动访问功能 (`AUTO_ACCESS`)。
    *   如果开启，服务器会启动时将自己的订阅链接上报到一个外部服务，该服务会定期访问这个链接，以防止服务器在一些免费托管平台上因长时间无活动而被休眠。

5.  **Web 首页服务**:
    *   服务器的根路径 (`/`) 会返回一个 `index.html` 页面，作为一个简单的 Web 服务前端。

### 原理分析 (Principle)

1.  **HTTP 与 WebSocket 共享端口**:
    *   项目使用 Node.js 内置的 `http` 模块创建了一个 HTTP 服务器，并使用 `ws` 库将 WebSocket 服务附加到同一个 HTTP 服务器上。这使得 HTTP 请求（如访问首页和订阅链接）和 WebSocket 连接请求可以同时在同一个端口（默认为 `7860`）上被处理。

2.  **WebSocket 隧道技术**:
    *   VLESS 和 Trojan 协议被巧妙地封装在标准的 WebSocket 流量中。这是实现代理和伪装的核心原理。
    *   **连接处理**: 当一个客户端通过 WebSocket 连接到服务器指定的路径 (`/${WSPATH}`) 时，服务器会进入等待状态。
    *   **协议嗅探**: 服务器会监听来自客户端的第一个数据包 (`ws.once('message', ...)`). 它通过分析这个数据包的结构特征来判断客户端使用的是 VLESS 协议还是 Trojan 协议。
    *   **数据转发**:
        *   一旦识别出协议，服务器会解析出客户端想要访问的真实 **目标地址和端口**。
        *   然后，它使用 Node.js 的 `net.connect` 创建一个到该真实目标的 **原生 TCP 连接**。
        *   最关键的一步是，它使用 `createWebSocketStream` 将客户端的 WebSocket 连接转换成一个标准的双工流，然后通过 `.pipe()` 方法，将 WebSocket 流和 TCP 连接流 **双向绑定** 在一起。
        *   这样就形成了一个数据隧道：`客户端 <--> WebSocket <--> 服务器 <--> TCP <--> 目标网站`。所有后续的数据都会在这个隧道中透明地传输，服务器本身不关心加密内容，只负责转发。

3.  **动态配置与环境变量**:
    *   整个应用是高度可配置的，几乎所有的关键参数（如用户 UUID、域名、哪吒服务器地址/密钥、WebSocket 路径等）都通过环境变量 (`process.env`) 来设置。这使得它非常适合在 Docker 或其他容器化环境中部署，无需修改任何代码即可完成配置。

4.  **后台进程执行**:
    *   哪吒监控 Agent 是通过 `child_process.exec` 在后台以守护进程的方式 (`setsid nohup ... &`) 启动的。这确保了 Agent 的运行独立于主 Node.js 进程，即使主进程出现问题，Agent 也可能继续运行，反之亦然。

**总结**:

该项目是一个精心设计的 Node.js 应用，它将一个 HTTP 服务器、一个能处理 VLESS/Trojan 代理协议的 WebSocket 服务器以及一个系统监控 Agent 整合在一起。其核心原理是利用 WebSocket 作为隧道来伪装和传输代理流量，并通过环境变量实现灵活部署，是一个非常典型的 "All-in-One" 代理解决方案。
